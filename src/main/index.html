<svelte:window on:popstate={onpopstate}/>

<main class="bookmarks {folderSwitching ? 'folder-switching' : ''}">
	{#if $items.length}
		{#each $items as item}
			<Tile item="{item}" />
		{/each}
	{/if}
</main>


<script>
import Tile from '../tile';
import { onMount } from 'svelte';
import {options, items, rootFolderTitle, currentFolder, currentFolderTitle} from '../store';
import Sortable from 'sortablejs';

let folderSwitching = false;

function optionsChanged (props) {
	document.documentElement.style.setProperty('--color', props.pageColor);
	document.documentElement.style.setProperty('--bg', props.pageBg);
	document.documentElement.style.setProperty('--icon-size', props.iconSize + 'px');
	document.documentElement.style.setProperty('--grid-width', props.gridWidth + 'px');
	document.documentElement.style.setProperty('--grid-gap', props.gridGap + 'px');
}


function onsort (e) {
	const {oldIndex, newIndex, item} = e;
	const id = item.dataset.id;
	console.log(id, item, oldIndex, newIndex);
}

function onpopstate (e) {
	if (e.state) $currentFolder = e.state.id
}

function folderChanged (folderId) {
	let id = folderId || $options.rootFolder;

	if (!history.state || !history.state.id || history.state.id !== folderId) {
		const fn = (id === $options.rootFolder) ? 'replaceState' : 'pushState';
		window.history[fn]({ id }, document.title, '');
	}
	folderSwitching = true;
	browser.bookmarks
		.getSubTree(id)
		.then(tree => {
			if (!tree || !tree.length) return;
			$currentFolder = tree[0].id;
			setTimeout(() => {
				$items = tree[0].children;
				folderSwitching = false;
			}, 100);
		});
}


onMount(() => {
	new Sortable(document.querySelector('.bookmarks'), { animation: 150, onSort: onsort });

	browser.storage.local
		.get('settings')
		.then(stored => options.set(Object.assign({}, $options, stored)));

	onpopstate(history);
	options.subscribe(optionsChanged);
	currentFolder.subscribe(folderChanged);
});
</script>
