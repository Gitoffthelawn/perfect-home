<svelte:window on:popstate={onpopstate}/>

<Palette data={allItems} />

<main class="bookmarks {folderSwitching ? 'folder-switching' : ''}">
	{#if $items.length}
		{#each $items as item}
			<Tile item="{item}" />
		{/each}
	{/if}
</main>


<script>
import Tile from '../tile';
import Palette from '../palette';
import {onMount} from 'svelte';
import {options, items, rootFolderTitle, currentFolder, currentFolderTitle, itemsLoaded} from '../store';
import {getSubTree, getSettings, updateIndexes, getAllItems} from '../lib';
import Sortable from 'sortablejs';

let folderSwitching = false;
let allItems = [];

function optionsChanged (props) {
	document.documentElement.style.setProperty('--color', props.pageColor);
	document.documentElement.style.setProperty('--bg', props.pageBg);
	document.documentElement.style.setProperty('--icon-size', props.iconSize + 'px');
	document.documentElement.style.setProperty('--grid-width', props.gridWidth + 'px');
	document.documentElement.style.setProperty('--grid-gap', props.gridGap + 'px');
}


function onsort (e) {
	updateIndexes(e.item.dataset.id, e.newIndex);
}

function onpopstate (e) {
	if (e.state) $currentFolder = e.state.id
}

function folderChanged (folderId) {
	let id = folderId || $options.rootFolder;

	if (!history.state || !history.state.id || history.state.id !== folderId) {
		const fn = (id === $options.rootFolder) ? 'replaceState' : 'pushState';
		window.history[fn]({ id }, document.title, '');
	}
	folderSwitching = true;
	getSubTree(id)
		.then(tree => {
			if (!tree || !tree.length) return;
			$currentFolder = tree[0].id;
			setTimeout(() => {
				$items = tree[0].children;
				folderSwitching = false;
				$itemsLoaded = true;
			}, 100);
		});
}


onMount(() => {
	new Sortable(document.querySelector('.bookmarks'), {
		animation: 150,
		ghostClass: 'sortable-ghost',
		chosenClass: 'sortable-chosen',
		onSort: onsort
	});

	getSettings().then(stored => options.set(Object.assign({}, $options, stored)));
	getAllItems().then(all => allItems = all);

	onpopstate(history);
	options.subscribe(optionsChanged);
	currentFolder.subscribe(folderChanged);
});
</script>
